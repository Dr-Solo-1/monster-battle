<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ممالك الظلال</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a1525, #1a2a40);
      color: #e0f7fa;
      text-align: center;
      padding: 10px;
      margin: 0;
      font-size: 18px;
      line-height: 1.6;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: rgba(13, 27, 45, 0.92);
      padding: 18px;
      border-radius: 20px;
      border: 2px solid #2a6b8a;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
    }
    h1 {
      color: #ffd700;
      text-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
      font-size: 30px;
      margin: 12px 0;
      letter-spacing: 1px;
    }
    .subtitle {
      color: #a8e6cf;
      font-style: italic;
      margin-bottom: 20px;
      font-size: 18px;
    }
    button {
      background: linear-gradient(to bottom, #2a7d45, #1e5d32);
      color: white;
      border: none;
      padding: 15px 22px;
      margin: 8px 6px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 19px;
      font-family: 'Segoe UI', sans-serif;
      width: 92%;
      max-width: 320px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      background: linear-gradient(to bottom, #3cb371, #2a7d45);
    }
    .combat-btns {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .combat-btns button {
      width: 46%;
      max-width: 150px;
      padding: 14px;
      font-size: 18px;
    }
    .stats {
      background: rgba(10, 30, 50, 0.85);
      padding: 18px;
      margin: 18px 0;
      border-radius: 16px;
      font-size: 20px;
      line-height: 1.9;
      border: 1px solid #2a6b8a;
    }
    .log {
      background: rgba(5, 18, 30, 0.88);
      height: 280px;
      overflow-y: auto;
      padding: 18px;
      border-radius: 16px;
      margin: 18px 0;
      text-align: right;
      border: 2px solid #2a6b8a;
      font-size: 20px;
      direction: rtl;
      scrollbar-width: thin;
      scrollbar-color: #2a7d45 #0a1a2a;
    }
    .log::-webkit-scrollbar {
      width: 8px;
    }
    .log::-webkit-scrollbar-track {
      background: #0a1a2a;
    }
    .log::-webkit-scrollbar-thumb {
      background: #2a7d45;
      border-radius: 4px;
    }
    .story {
      background: rgba(20, 45, 65, 0.6);
      padding: 18px;
      border-radius: 16px;
      margin: 18px 0;
      font-size: 21px;
      font-style: italic;
      color: #c1f0c1;
      min-height: 50px;
    }
    .zone-title {
      background: rgba(30, 70, 90, 0.5);
      padding: 14px;
      border-radius: 14px;
      margin: 16px 0;
      font-size: 24px;
      font-weight: bold;
      color: #88e688;
      text-shadow: 0 0 8px rgba(136, 230, 136, 0.4);
    }
    .choices {
      margin: 20px 0;
      padding: 18px;
      background: rgba(40, 50, 80, 0.5);
      border-radius: 16px;
      border: 1px solid #5d4a7a;
    }
    .adventure-log {
      margin-top: 20px;
      padding: 14px;
      background: rgba(25, 40, 60, 0.5);
      border-radius: 14px;
      font-size: 17px;
      color: #ffd700;
    }
    .adventure-log h3 {
      margin-top: 0;
      color: #ffd700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏰 ممالك الظلال</h1>
    <div class="subtitle">مغامرة عربية خيالية في قلب الأساطير...</div>

    <div id="startScreen">
      <p>اختر بطلَك من أبطال القبيلة:</p>
      <button onclick="startGame('الفارس')">الفارس ⚔️ (هجوم عالي)</button>
      <button onclick="startGame('الحكيم')">الحكيم 📜 (صحة أعلى)</button>
      <button onclick="startGame('الصياد')">الصياد 🏹 (توازن)</button>
    </div>

    <div id="gameScreen" style="display:none;">
      <div class="stats" id="statsBox">
        البطل: <span id="heroName">—</span><br>
        المستوى: <span id="level">1</span><br>
        الصحة: <span id="heroHP">100</span> / <span id="maxHP">100</span> ❤️<br>
        الهجوم: <span id="heroAtk">15</span> 💥<br>
        الذهب: <span id="gold">0</span> 💰<br>
        السمعة: <span id="reputation">محايد</span> 🌟
      </div>

      <div class="zone-title" id="zoneTitle">الغابة الملعونة</div>

      <div class="story" id="storyText">الغابة هادئة... لكنك تشعر أن شيئًا يراقبك من بين الأشجار.</div>

      <div class="log" id="battleLog">مرحبًا بك في ممالك الظلال!</div>

      <!-- أزرار التنقل بين المناطق -->
      <div style="margin: 20px 0;">
        <button onclick="changeZone('الغابة')">🌲 الغابة الملعونة</button>
        <button onclick="changeZone('الواحة')">🌴 الواحة المحرّمة</button>
        <button onclick="changeZone('الجبال')">⛰️ جبال الجن</button>
        <button id="castleBtn" onclick="unlockCastle()" style="display:none;">🏰 قلعة الظلال</button>
      </div>

      <button onclick="explore()">⚔️ استكشف المنطقة</button>
      <button onclick="upgrade('hp')">❤️ +20 صحة (20 ذهب)</button>
      <button onclick="upgrade('atk')">💥 +5 هجوم (25 ذهب)</button>
      <button onclick="showAdventureLog()">📜 سجل المغامرات</button>
      <button onclick="resetGame()">🔄 ابدأ من جديد</button>

      <div id="choicesSection" class="choices" style="display:none;"></div>

      <div id="adventureLogSection" class="adventure-log" style="display:none;">
        <h3>سجل مغامراتك:</h3>
        <div id="adventureLogContent">لا توجد أحداث بعد.</div>
      </div>
    </div>
  </div>

  <script>
    // =============== الحالة الأساسية للعبة ===============
    let game = JSON.parse(localStorage.getItem('shadowKingdomsEpic')) || {
      hero: null,
      gold: 0,
      wins: 0,
      currentZone: "الغابة",
      reputation: 0,
      adventureLog: [],
      unlockedCastle: false
    };

    // =============== دوال مساعدة ===============
    function log(msg) {
      const logBox = document.getElementById('battleLog');
      logBox.innerHTML += msg + '<br>';
      logBox.scrollTop = logBox.scrollHeight;
      addToAdventureLog(msg);
      saveGame();
    }

    function addToAdventureLog(msg) {
      // لا نضيف رسائل التحديث أو الفراغ
      if (msg.includes("الصحة:") || msg.includes("الذهب:") || msg === "") return;
      game.adventureLog.push(`• ${msg}`);
      // نحافظ على آخر 15 حدث
      if (game.adventureLog.length > 15) {
        game.adventureLog.shift();
      }
    }

    function showAdventureLog() {
      const section = document.getElementById('adventureLogSection');
      const content = document.getElementById('adventureLogContent');
      if (game.adventureLog.length === 0) {
        content.innerHTML = "لا توجد أحداث بعد.";
      } else {
        content.innerHTML = game.adventureLog.join('<br>');
      }
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function saveGame() {
      localStorage.setItem('shadowKingdomsEpic', JSON.stringify(game));
    }

    function getReputationText() {
      if (game.reputation >= 8) return "أسطوري";
      if (game.reputation >= 5) return "شجاع";
      if (game.reputation >= 2) return "كريم";
      if (game.reputation <= -8) return " traitor";
      if (game.reputation <= -5) return "جبان";
      if (game.reputation <= -2) return "جشع";
      return "محايد";
    }

    function updateUI() {
      if (!game.hero) return;
      document.getElementById('heroName').textContent = game.hero.name;
      document.getElementById('heroHP').textContent = game.hero.hp;
      document.getElementById('maxHP').textContent = game.hero.maxHp;
      document.getElementById('heroAtk').textContent = game.hero.atk;
      document.getElementById('gold').textContent = game.gold;
      document.getElementById('level').textContent = Math.floor(game.wins / 3) + 1;
      document.getElementById('reputation').textContent = getReputationText();
      
      const zoneData = zones[game.currentZone];
      document.getElementById('zoneTitle').textContent = zoneData.name;
      document.getElementById('storyText').textContent = 
        zoneData.story[Math.floor(Math.random() * zoneData.story.length)];
      
      // إظهار قلعة الظلال لو فُتحت
      if (game.unlockedCastle) {
        document.getElementById('castleBtn').style.display = 'block';
      }
    }

    function showChoices(choices, text) {
      let html = `<p style="font-size:20px;">${text}</p>`;
      choices.forEach((c, i) => {
        html += `<button onclick="handleChoice(${i})">${c.text}</button>`;
      });
      document.getElementById('choicesSection').innerHTML = html;
      document.getElementById('choicesSection').style.display = 'block';
      window.currentChoices = choices;
    }

    function handleChoice(index) {
      window.currentChoices[index].effect();
      document.getElementById('choicesSection').style.display = 'none';
      updateUI();
    }

    // =============== الشخصيات الجانبية ===============
    const npcs = {
      "الغابة": [
        {
          name: "العجوز الحكيم",
          dialogue: "السلام عليك، يا بطل... هل تبحث عن الحقيقة التي تحرق، أم القوة التي تهدم؟",
          choices: [
            { 
              text: "أبحث عن الحقيقة", 
              effect: () => { 
                game.reputation += 3; 
                log("العجوز: 'الحقيقة ستحررك... حتى لو أوجعتك.'"); 
              } 
            },
            { 
              text: "أبحث عن القوة", 
              effect: () => { 
                game.hero.atk += 4; 
                log("العجوز: 'القوة تُغري... لكنها لا تُرضي.'"); 
              } 
            }
          ]
        },
        {
          name: "اللص الجريح",
          dialogue: "ساعدني... وسأخبرك بسرٍّ عن كنزٍ مدفون تحت جذور الشجرة العظيمة!",
          choices: [
            { 
              text: "أساعده", 
              effect: () => { 
                game.gold += 40; 
                game.reputation += 2;
                log("اللص: 'الكنز في قلب الغابة... احترس من العيون الخفية!'"); 
              } 
            },
            { 
              text: "أتركه يموت", 
              effect: () => { 
                game.reputation -= 3; 
                log("اللص: 'ستندم... الظلام يعرف طريقك الآن.'"); 
              } 
            }
          ]
        }
      ],
      "الواحة": [
        {
          name: "التاجر الغامض",
          dialogue: "لديّ سحرٌ من زمن الفراعنة... لكنه لا يُشترى بالذهب وحده.",
          choices: [
            { 
              text: "أدفع 35 ذهبًا", 
              effect: () => { 
                if (game.gold >= 35) {
                  game.gold -= 35;
                  game.hero.maxHp += 30;
                  game.hero.hp += 30;
                  log("حصلت على سحر الحياة الأزلي! (+30 صحة دائمة)");
                } else {
                  log("ليس لديك ذهب كافٍ!");
                }
              } 
            },
            { 
              text: "ماذا تريد بدل الذهب؟", 
              effect: () => { 
                if (game.reputation >= 3) {
                  game.hero.maxHp += 20;
                  game.hero.hp += 20;
                  log("التاجر: 'سمعتُ عن شجاعتك... خذ هذا هدية.'");
                } else {
                  log("التاجر: 'عُدْ حين تصبح جديرًا.'");
                }
              } 
            }
          ]
        },
        {
          name: "الراقصة الغامضة",
          dialogue: "أرى مستقبلك في رمال الواحة... هل تريد أن تعرف؟",
          choices: [
            { 
              text: "أخبريني", 
              effect: () => { 
                log("الراقصة: 'ستواجه ملك الظلال... وستختار بين العرش والضمير.'");
                game.reputation += 1;
              } 
            },
            { 
              text: "المستقبل يُصنع، لا يُقرأ", 
              effect: () => { 
                game.hero.atk += 3;
                log("الراقصة: 'إرادة قوية... ستنجو.'");
              } 
            }
          ]
        }
      ],
      "الجبال": [
        {
          name: "الفارسة المجهولة",
          dialogue: "أبحث عن من يقف معي ضد ملك الظلال. هل أنت جاهز لقسم الدم؟",
          choices: [
            { 
              text: "نعم، أقسم", 
              effect: () => { 
                game.reputation += 4;
                game.unlockedCastle = true;
                log("الفارسة: 'القلعة مفتوحة لك الآن. سأنتظرك هناك.'");
                document.getElementById('castleBtn').style.display = 'block';
              } 
            },
            { 
              text: "ليس بعد", 
              effect: () => { 
                log("الفارسة: 'الخوف لا يبني الممالك... لكنه يحمي الأرواح أحيانًا.'");
              } 
            }
          ]
        },
        {
          name: "الساحر العجوز",
          dialogue: "الجبال تهمس بأسماء الأموات... هل تريد أن تستدعي روحًا؟",
          choices: [
            { 
              text: "استدعِ روح حليف", 
              effect: () => { 
                if (game.gold >= 50) {
                  game.gold -= 50;
                  log("روح محارب قديم يحارب معك في المعركة القادمة! (+15 هجوم مؤقت)");
                  game.tempAtkBoost = 15;
                } else {
                  log("الساحر: 'الأسعار مرتفعة في الجبال.'");
                }
              } 
            },
            { 
              text: "لا، هذا سحر محرم", 
              effect: () => { 
                game.reputation += 2;
                log("الساحر: 'الحكمة أقوى من السحر.'");
              } 
            }
          ]
        }
      ],
      "القلعة": [
        {
          name: "ملك الظلال",
          dialogue: "ها قد وصلت... هل جئت لتقتلني، أم لتنضم إليّ؟",
          choices: [
            { 
              text: "سأجهزك!", 
              effect: () => { 
                log("الملك: 'إذن... لتكن المعركة الأخيرة!'");
                startBattle(bossMonster);
              } 
            },
            { 
              text: "ما القوة التي تملكها؟", 
              effect: () => { 
                if (game.reputation <= -5) {
                  log("الملك: 'أرى أنك فهمت الحقيقة... تعال، خذ مكانك بجانبي.'");
                  endGame("dark");
                } else {
                  log("الملك: 'الفضول يقتلك!' — يهاجمك فجأة!");
                  startBattle(bossMonster);
                }
              } 
            }
          ]
        }
      ]
    };

    // =============== أنواع الوحوش ===============
    const monsterTypes = {
      common: { fleeChance: 0.4, fearThreshold: 0.3, name: "عادي" },
      rare: { fleeChance: 0.1, fearThreshold: 0.15, name: "نادر" },
      elite: { fleeChance: 0, fearThreshold: 0, name: "نخبة" },
      boss: { fleeChance: 0, fearThreshold: 0, name: "رئيس" }
    };

    // =============== عالم اللعبة (المناطق) ===============
    const zones = {
      "الغابة": {
        name: "الغابة الملعونة",
        story: [
          "تسمع صريرًا بين الأغصان... شيء يقترب!",
          "وجدت أثر أقدام غريبة على التراب.",
          "ضباب كثيف يلف المكان. الرؤية شبه معدومة...",
          "أشجار الغابة تتحرك ببطء... هل هي حية؟",
          "سمعت همسًا قديمًا: 'الكنز تحت جذور الشجرة العظيمة...'"
        ],
        monsters: [
          { name: "ذئب الضباب", hp: 35, atk: 9, type: "common" },
          { name: "شجرة الغول", hp: 55, atk: 13, type: "common" },
          { name: "العنكبوت السام", hp: 75, atk: 17, type: "rare" },
          { name: "حارس الغابة", hp: 100, atk: 22, type: "elite" }
        ]
      },
      "الواحة": {
        name: "الواحة المحرّمة",
        story: [
          "نخيل عتيق يحيط بماء أزرق لامع... لكن الحذر، فالواحة ملعونة!",
          "سمعت صوت ناي بعيد... من يعزف في هذا المكان المقفر؟",
          "رمال ذهبية تلمع تحت الشمس. هل هي كنز أم فخ؟",
          "ظلٌّ طويل يتحرك بين النخيل... لا ينتمي لأي إنسان.",
          "ماء الواحة يهمس بأسماء الضائعين..."
        ],
        monsters: [
          { name: "عفريت الرمال", hp: 45, atk: 11, type: "common" },
          { name: "الحية الذهبية", hp: 65, atk: 15, type: "rare" },
          { name: "شيطان الواحة", hp: 90, atk: 20, type: "elite" },
          { name: "جنّي الرمال", hp: 120, atk: 25, type: "rare" }
        ]
      },
      "الجبال": {
        name: "جبال الجن",
        story: [
          "صخور شاهقة تهمس بأسرار قديمة. هل تجرؤ على الصعود؟",
          "رأيت نورًا أزرق يلمع في كهف بعيد...",
          "الرياح تحمل همسات بلغة لم تسمعها من قبل...",
          "أحجار الجبال تتحرك ليلاً... تبحث عن ضحاياها.",
          "سمعت صرخة من أعماق الكهف... هل هي استغاثة أم فخ؟"
        ],
        monsters: [
          { name: "غول الجبال", hp: 60, atk: 14, type: "common" },
          { name: "النسر الساحر", hp: 80, atk: 18, type: "rare" },
          { name: "حارس الكهف", hp: 110, atk: 24, type: "elite" },
          { name: "التنين الصغير", hp: 140, atk: 28, type: "rare" }
        ]
      },
      "القلعة": {
        name: "قلعة الظلال",
        story: [
          "أبواب القلعة مفتوحة... كأنها تنتظرك.",
          "الجدران تنزف دمًا قديمًا.",
          "صرخات الأموات تملأ الممرات.",
          "العرش فارغ... لكن العيون تراقبك.",
          "الهواء ثقيل... كأن الزمن توقف هنا."
        ],
        monsters: []
      }
    };

    // =============== الوحش الرئيس ===============
    const bossMonster = { name: "ملك الظلال", hp: 250, atk: 35, type: "boss" };

    // =============== بدء اللعبة ===============
    function startGame(heroType) {
      let hp = 100, atk = 15;
      if (heroType === 'الحكيم') { hp = 140; atk = 12; }
      else if (heroType === 'الصياد') { hp = 115; atk = 17; }

      game.hero = { name: heroType, maxHp: hp, hp: hp, atk: atk };
      game.gold = 0;
      game.wins = 0;
      game.reputation = 0;
      game.adventureLog = [];
      game.unlockedCastle = false;
      game.currentZone = "الغابة";
      log(`مرحبًا، أيها ${heroType}! بدأت رحلتك في ممالك الظلال...`);
      updateUI();
      
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
    }

    function changeZone(zoneName) {
      if (!game.hero || game.hero.hp <= 0) return;
      if (zoneName === "القلعة" && !game.unlockedCastle) {
        log("القلعة مغلقة... ابحث عن من يفتحها لك.");
        return;
      }
      game.currentZone = zoneName;
      log(`انتقلت إلى: ${zones[zoneName].name}`);
      
      // فرصة لقاء شخصية (70%)
      if (npcs[zoneName] && Math.random() > 0.3) {
        const npcList = npcs[zoneName];
        const npc = npcList[Math.floor(Math.random() * npcList.length)];
        showChoices(npc.choices, `${npc.name} يقول: "${npc.dialogue}"`);
      }
      updateUI();
    }

    function unlockCastle() {
      changeZone("القلعة");
    }

    // =============== نظام الهروب ===============
    function tryToFlee(monster) {
      const type = monsterTypes[monster.type];
      // السرعة تعتمد على مستوى البطل
      const heroSpeed = Math.floor(game.wins / 2) + 1;
      const baseChance = type.fleeChance;
      const finalChance = Math.min(0.8, baseChance + (heroSpeed * 0.05));
      
      if (Math.random() < finalChance) {
        log("هربت من المعركة بنجاح! 🏃‍♂️");
        return true;
      } else {
        log("فشلت في الهروب! الوحش يهاجمك بغضب! 💢");
        return false;
      }
    }

    // =============== بدء المعركة ===============
    function startBattle(monster) {
      log(`ظهر ${monster.name}! (${monsterTypes[monster.type].name})`);
      
      const html = `
        <div class="combat-btns">
          <button onclick="fightMonster('${monster.name}', ${monster.hp}, ${monster.atk}, '${monster.type}')">⚔️ واجهه</button>
          <button onclick="handleFlee('${monster.name}', ${monster.hp}, ${monster.atk}, '${monster.type}')">🏃 هرب</button>
        </div>
      `;
      document.getElementById('choicesSection').innerHTML = html;
      document.getElementById('choicesSection').style.display = 'block';
    }

    function handleFlee(name, hp, atk, type) {
      const monster = { name, hp, atk, type };
      if (tryToFlee(monster)) {
        // نجاح الهروب
      } else {
        // فشل الهروب → هجوم فوري
        let damage = atk;
        if (game.hero.atk > atk * 1.8) {
          damage = Math.max(1, Math.floor(damage * 0.6));
          log(`${name} يرتجف من الخوف!`);
        }
        game.hero.hp -= damage;
        if (game.hero.hp < 0) game.hero.hp = 0;
        log(`${name} هاجمك بـ ${damage} ضرر!`);
        if (game.hero.hp <= 0) {
          log("لقد سقطت في ممالك الظلال... الظلام يلفك. 💀");
        }
        updateUI();
      }
      document.getElementById('choicesSection').style.display = 'none';
    }

    // =============== قتال كامل ===============
    function fightMonster(name, hp, atk, type) {
      document.getElementById('choicesSection').style.display = 'none';
      
      let monsterHP = hp;
      let turn = 0;
      const interval = setInterval(() => {
        // ذكاء الوحش: هل يهرب؟
        if (turn > 0 && turn % 2 === 1) {
          const typeData = monsterTypes[type];
          const healthRatio = monsterHP / hp;
          if (healthRatio < typeData.fearThreshold && Math.random() < 0.6) {
            log(`${name} يهرب من المعركة!`);
            game.gold += Math.floor(Math.random() * 15) + 10;
            log("حصلت على ذهب من ممتلكاته!");
            game.wins++;
            updateUI();
            clearInterval(interval);
            return;
          }
        }

        if (turn % 2 === 0) {
          // البطل يهاجم
          let damage = game.hero.atk;
          if (game.tempAtkBoost) {
            damage += game.tempAtkBoost;
            delete game.tempAtkBoost;
          }
          monsterHP -= damage;
          log(`هاجمت ${name} بـ ${damage} ضرر! 💥`);
          if (monsterHP <= 0) {
            // شفاء بعد القتال (بدون تجاوز الحد الأقصى)
            game.hero.hp = Math.min(game.hero.maxHp, game.hero.hp + 30);
            // مكافأة ذكية
            let reward = 20;
            if (type === "rare") reward = 40;
            else if (type === "elite") reward = 60;
            else if (type === "boss") reward = 120;
            
            game.gold += reward;
            game.wins++;
            log(`هزَمت ${name}! (+30 صحة، +${reward} ذهب) 🎉`);
            updateUI();
            clearInterval(interval);
            return;
          }
        } else {
          // الوحش يهاجم
          let damage = atk;
          // تأثير الخوف
          if (game.hero.atk > atk * 1.7) {
            damage = Math.max(1, Math.floor(damage * 0.65));
            log(`${name} يرتجف من قوتك!`);
          }
          game.hero.hp -= damage;
          if (game.hero.hp < 0) game.hero.hp = 0;
          log(`${name} هاجمك بـ ${damage} ضرر! 🩸`);
          if (game.hero.hp <= 0) {
            log("لقد سقطت في ممالك الظلال... الظلام يلفك. 💀");
            updateUI();
            clearInterval(interval);
            return;
          }
          updateUI();
        }
        turn++;
      }, 1100);
    }

    // =============== استكشاف ===============
    function explore() {
      if (!game.hero || game.hero.hp <= 0) {
        log("لقد سقطت... ابدأ من جديد.");
        return;
      }

      if (game.currentZone === "القلعة") {
        log("الملك ينتظرك في العرش... اذهب للحديث معه.");
        return;
     
